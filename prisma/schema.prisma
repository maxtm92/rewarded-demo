generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// â”€â”€â”€ Auth.js managed tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// â”€â”€â”€ Core user â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  phone         String?   @unique
  password      String?

  // App-specific fields
  balanceCents    Int      @default(0) @map("balance_cents")
  lifetimeCents   Int      @default(0) @map("lifetime_cents")
  marketingOptIn    Boolean  @default(false) @map("marketing_opt_in")
  marketingSmsOptIn Boolean  @default(false) @map("marketing_sms_opt_in")
  phoneOptInBonus   Boolean  @default(false) @map("phone_opt_in_bonus")
  onboardingDone    Boolean  @default(false) @map("onboarding_done")
  profileComplete   Boolean  @default(false) @map("profile_complete")
  role              UserRole @default(USER)
  pushToken         String?  @map("push_token")
  isBanned          Boolean  @default(false) @map("is_banned")

  // IP geolocation & device info
  ipCountry  String? @map("ip_country")
  ipRegion   String? @map("ip_region")
  ipCity     String? @map("ip_city")
  ipZipcode  String? @map("ip_zipcode")
  deviceType String? @map("device_type")
  browser    String? @map("browser")
  os         String? @map("os")

  // Referral system
  referralCode String? @unique @map("referral_code")
  referredById String? @map("referred_by_id")
  referredBy   User?   @relation("Referrals", fields: [referredById], references: [id])
  referrals    User[]  @relation("Referrals")

  // Daily login streak
  currentStreak Int       @default(0) @map("current_streak")
  longestStreak Int       @default(0) @map("longest_streak")
  lastLoginDate DateTime? @map("last_login_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accounts                Account[]
  sessions                Session[]
  transactions            Transaction[]
  postbacks               Postback[]
  surveyResponse          SurveyResponse?
  utmCaptures             UtmCapture[]
  withdrawals             Withdrawal[]
  premiumOfferCompletions PremiumOfferCompletion[]
  referralEarningsAsReferrer ReferralEarning[] @relation("ReferrerEarnings")
  referralEarningsAsReferred ReferralEarning[] @relation("ReferredEarnings")
  achievements            UserAchievement[]
  leaderboardEntries      LeaderboardEntry[]
  funnelEvents            FunnelEvent[]
  notifications           Notification[]

  @@map("users")
}

// â”€â”€â”€ Transactions & wallet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum TransactionType {
  EARNING
  WITHDRAWAL
  BONUS
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  REJECTED
}

model Transaction {
  id               String            @id @default(cuid())
  userId           String            @map("user_id")
  type             TransactionType
  amountCents      Int               @map("amount_cents")
  balanceAfterCents Int              @map("balance_after_cents")
  source           String            // offerwall slug, "withdrawal", "signup_bonus", etc.
  description      String?
  status           TransactionStatus @default(COMPLETED)

  postbackId String?  @unique @map("postback_id")
  postback   Postback? @relation(fields: [postbackId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("transactions")
}

enum WithdrawalMethod {
  PAYPAL
  VENMO
  GOOGLE_PLAY
  AMAZON
  APPLE
  VISA
  BANK
  BTC
  LTC
  SOL
  DOGE
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
}

model Withdrawal {
  id          String           @id @default(cuid())
  userId      String           @map("user_id")
  amountCents Int              @map("amount_cents")
  method      WithdrawalMethod
  destination String?
  status      WithdrawalStatus @default(PENDING)
  note             String?
  rejectionReason  String?          @map("rejection_reason")

  // Timeline tracking
  processedAt           DateTime? @map("processed_at")
  completedAt           DateTime? @map("completed_at")
  rejectedAt            DateTime? @map("rejected_at")
  estimatedCompletionAt DateTime? @map("estimated_completion_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("withdrawals")
}

// â”€â”€â”€ Referral system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model ReferralEarning {
  id                  String   @id @default(cuid())
  referrerId          String   @map("referrer_id")
  referredUserId      String   @map("referred_user_id")
  sourceTransactionId String   @unique @map("source_transaction_id")
  amountCents         Int      @map("amount_cents")

  createdAt DateTime @default(now()) @map("created_at")

  referrer     User @relation("ReferrerEarnings", fields: [referrerId], references: [id])
  referredUser User @relation("ReferredEarnings", fields: [referredUserId], references: [id])

  @@index([referrerId])
  @@index([referredUserId])
  @@map("referral_earnings")
}

// â”€â”€â”€ Achievements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Achievement {
  id          String @id @default(cuid())
  slug        String @unique
  name        String
  description String
  icon        String @default("ğŸ†")
  category    String // "earning", "withdrawal", "streak", "referral", "milestone"
  threshold   Int    @default(0)
  sortOrder   Int    @default(0) @map("sort_order")

  users UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// â”€â”€â”€ Leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model LeaderboardEntry {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  period      String   // "weekly_2026-W08", "monthly_2026-02"
  earnedCents Int      @default(0) @map("earned_cents")
  rank        Int?

  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, period])
  @@index([period, earnedCents])
  @@map("leaderboard_entries")
}

// â”€â”€â”€ Offerwalls & postbacks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model OfferWall {
  id               String  @id @default(cuid())
  slug             String  @unique
  name             String
  description      String?
  logoUrl          String? @map("logo_url")
  isActive         Boolean @default(true) @map("is_active")
  iframeUrl        String? @map("iframe_url")
  redirectUrl      String? @map("redirect_url")
  postbackSecret   String  @map("postback_secret")
  payoutMultiplier Float   @default(1.0) @map("payout_multiplier")
  sortOrder        Int     @default(0) @map("sort_order")
  icon             String  @default("ğŸ’°")

  // Everflow integration
  everflowOfferId    String?   @map("everflow_offer_id")
  everflowAffId      String?   @map("everflow_aff_id")
  everflowOfferName  String?   @map("everflow_offer_name")
  everflowStatus     String?   @map("everflow_status")
  everflowPayoutType String?   @map("everflow_payout_type")
  everflowDestUrl    String?   @map("everflow_dest_url")
  everflowLastSyncAt DateTime? @map("everflow_last_sync_at")

  // Earn page control
  bonusText   String?  @map("bonus_text")    // e.g. "$10", "$5"
  bonusDetail String?  @map("bonus_detail")  // e.g. "Must complete one game to claim"
  section     String   @default("games")     // "games" or "surveys"
  isFeatured  Boolean  @default(false) @map("is_featured")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  postbacks Postback[]

  @@map("offer_walls")
}

enum PostbackStatus {
  CREDITED
  REVERSED
  REJECTED
}

model Postback {
  id          String         @id @default(cuid())
  offerWallId String         @map("offer_wall_id")
  userId      String         @map("user_id")
  externalId  String         @map("external_id")
  offerId     String?        @map("offer_id")
  offerName   String?        @map("offer_name")
  payoutCents Int            @map("payout_cents")
  status      PostbackStatus @default(CREDITED)
  ipAddress   String?        @map("ip_address")
  rawPayload  Json?          @map("raw_payload")

  createdAt DateTime @default(now()) @map("created_at")

  offerWall   OfferWall    @relation(fields: [offerWallId], references: [id])
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction Transaction?

  @@unique([offerWallId, externalId])
  @@index([userId])
  @@map("postbacks")
}

// â”€â”€â”€ Onboarding survey â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model SurveyResponse {
  id            String    @id @default(cuid())
  userId        String    @unique @map("user_id")
  ageRange      String?   @map("age_range")
  gender        String?
  interests     String[]  @default([])
  income        String?
  country       String?
  zipCode       String?   @map("zip_code")
  timeAvailable String?   @map("time_available")
  completedAt   DateTime? @map("completed_at")
  bonusCredited Boolean   @default(false) @map("bonus_credited")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("survey_responses")
}

// â”€â”€â”€ UTM tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model UtmCapture {
  id         String  @id @default(cuid())
  userId     String  @map("user_id")
  source     String? @map("utm_source")
  medium     String? @map("utm_medium")
  campaign   String? @map("utm_campaign")
  term       String? @map("utm_term")
  content    String? @map("utm_content")
  landingUrl String? @map("landing_url")
  referrer   String?

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("utm_captures")
}

// â”€â”€â”€ Marketing angles (split testing) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model MarketingAngle {
  id             String  @id @default(cuid())
  slug           String  @unique
  name           String
  headline       String
  subheadline    String?
  description    String?
  ctaText        String  @map("cta_text")
  imageUrl       String? @map("image_url")
  targetAudience String? @map("target_audience")
  isActive       Boolean @default(true) @map("is_active")
  weight         Int     @default(1)

  impressions Int @default(0)
  clicks      Int @default(0)
  conversions Int @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("marketing_angles")
}

// â”€â”€â”€ Premium offers (lead gen) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model PremiumOffer {
  id             String  @id @default(cuid())
  slug           String  @unique
  name           String
  headline       String
  description    String
  payoutCents    Int     @map("payout_cents")
  advertiserName String? @map("advertiser_name")
  externalUrl    String  @map("external_url")
  imageUrl       String? @map("image_url")
  category       String  // "auto_insurance", "credit_card", "education", etc.
  isActive       Boolean @default(true) @map("is_active")
  sortOrder      Int     @default(0) @map("sort_order")
  icon           String  @default("ğŸ’°")

  angleId String? @map("angle_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  completions PremiumOfferCompletion[]

  @@map("premium_offers")
}

model PremiumOfferCompletion {
  id         String @id @default(cuid())
  userId     String @map("user_id")
  offerId    String @map("offer_id")
  status     String @default("PENDING")
  earnedCents Int   @default(0) @map("earned_cents")

  createdAt DateTime @default(now()) @map("created_at")

  user  User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  offer PremiumOffer @relation(fields: [offerId], references: [id])

  @@unique([userId, offerId])
  @@map("premium_offer_completions")
}

// â”€â”€â”€ Funnel event tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model FunnelEvent {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  event     String   // page_view, offer_click, offer_complete, survey_complete, phone_optin, withdrawal_request
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([event, createdAt])
  @@map("funnel_events")
}

// â”€â”€â”€ In-app notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Notification {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  type      String    // offer_complete, phone_bonus, etc.
  title     String
  message   String
  data      Json?
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt])
  @@map("notifications")
}
